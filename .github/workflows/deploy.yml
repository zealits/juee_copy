name: Deploy Application

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"

      #   - name: Install Dependencies
      #     run: |
      #       cd front-end
      #       npm install
      #       cd ../back-end
      #       npm install

      #   - name: Build Frontend
      #     run: |
      #       cd front-end
      #       npm run build:prod
      #     env:
      #       VITE_APP_MODE: production

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H dev.zealits.com >> ~/.ssh/known_hosts

      - name: Deploy to server
        if: github.ref == 'refs/heads/main'
        run: |
          ssh admin@dev.zealits.com << 'EOF'
            # Create directory if it doesn't exist
            mkdir -p /var/www/meetings

            # Check if repository exists
            if [ -d "/var/www/meetings/juee_copy" ]; then
              echo "Repository exists, pulling latest changes..."
              cd /var/www/meetings/juee_copy
              git pull origin main
            else
              echo "Cloning repository..."
              cd /var/www/meetings
              git clone https://github.com/zealits/juee_copy.git
              cd juee_copy
            fi

            # Make setup script executable and run it
            chmod +x setup.sh
            ./setup.sh
          EOF
